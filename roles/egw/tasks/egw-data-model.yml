---
- name: Pull in the secrets
  include_vars: files/vault.yml
  no_log: true

- name: Create EGW namespace
  #                                                                        this is v0.1.0-pre2
  shell: "curl -s --header \"PRIVATE-TOKEN: {{ gitlab_toby_ansible_ro }}\" https://gitlab.com/api/v4/projects/21452659/jobs/770626023/artifacts/config/crd/egw-namespace.yaml | kubectl apply -f -"
  args:
    warn: false
  register: result
  failed_when: result.rc != 0 and "AlreadyExists" not in result.stderr

- name: Apply EGW custom resource definitions
  #                                                                        this is v0.1.0-pre2
  shell: "curl -s --header \"PRIVATE-TOKEN: {{ gitlab_toby_ansible_ro }}\" https://gitlab.com/api/v4/projects/21452659/jobs/770626023/artifacts/config/crd/bases/egw.acnodal.io.yaml | kubectl apply -f -"
  args:
    warn: false

- name: Create sample namespace
  #                                                                        this is v0.1.0-pre2
  shell: "curl -s --header \"PRIVATE-TOKEN: {{ gitlab_toby_ansible_ro }}\" https://gitlab.com/api/v4/projects/21452659/jobs/770626023/artifacts/config/samples/namespace.yaml | kubectl apply -f -"
  args:
    warn: false
  register: result
  failed_when: result.rc != 0 and "AlreadyExists" not in result.stderr

- name: Create sample account
  #                                                                        this is v0.1.0-pre2
  shell: "curl -s --header \"PRIVATE-TOKEN: {{ gitlab_toby_ansible_ro }}\" https://gitlab.com/api/v4/projects/21452659/jobs/770626023/artifacts/config/samples/egw_v1_account.yaml | kubectl apply -f -"
  args:
    warn: false

- name: Create sample service group
  #                                                                        this is v0.1.0-pre2
  shell: "curl -s --header \"PRIVATE-TOKEN: {{ gitlab_toby_ansible_ro }}\" https://gitlab.com/api/v4/projects/21452659/jobs/770626023/artifacts/config/samples/egw_v1_servicegroup.yaml | kubectl apply -f -"
  args:
    warn: false
