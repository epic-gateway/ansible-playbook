#!/usr/bin/python3

import docker
import json
import netifaces
import subprocess
from kubernetes import client, config, watch


GROUP="egw.acnodal.io"
V1="v1"
LB_PLURAL="loadbalancers"

# FIXME: get this from the serviceprefix
MULTUS_BRIDGE_NAME = 'multus0'


def find_veth(container_id):
    # use the container id to find the docker pid
    podpid = dclient.containers.get(container_id).attrs['Config']['Labels']['io.kubernetes.sandbox.id']
    print("Pod PID: ", podpid)

    # use the primary pod container to find the "pause" container
    pausepid = int(dclient.containers.get(podpid).attrs['State']['Pid'])
    print("Pause container PID: ", pausepid)

    # find all of the net namespaces
    cp = subprocess.run(['/usr/bin/lsns', '-Jt', 'net'], capture_output=True)
    if cp.returncode != 0:
        print("error running lsns", cp.stderr)
        return
    nss = json.loads(cp.stdout)['namespaces']

    # find the namespace that contains the "pause" container
    for ns in filter(lambda ns: ns['pid'] == pausepid, nss):
        nsid = int(ns['netnsid'])
        print("Netnsid: ", nsid)

        # get veth interface
        d = subprocess.run(["/usr/sbin/ip", "-j", "link", "show"], capture_output=True)
        if d.returncode == 0:
            for dev in json.loads(d.stdout):
                if 'master' in dev and dev['master'] == MULTUS_BRIDGE_NAME and 'link_netnsid' in dev and dev['link_netnsid'] == nsid:
                    ifname = dev['ifname']
                    ifindex = dev['ifindex']
                    print("veth: ", ifname, " ifindex: ", ifindex)
                    return ifname, ifindex

    print("veth not found for container", container_id)
    return False, -1


def container_name_to_service_name(container_name):
    '''The container name is the service name prefixed by "envoy-" so we
    can strip the "envoy-" to get back to the service name.

    '''
    return container_name.split("envoy-")[1]


def handle_event(event):

    if event['type'] not in ['ADDED', 'MODIFIED']:
        print("Event is not an ADDED/MODIFIED type, ignoring")
        return

    print(event['object'].status)

    if None == event['object'].status.container_statuses:
        print("Event has no container status, cannot proceed")
        return

    if None == event['object'].status.container_statuses[0].container_id:
        print("Container doesn't have an id yet, cannot proceed")
        return

    # FIXME: return if this event isn't happening on this host

    api = client.CustomObjectsApi()

    # start by finding the container id
    containerid = event['object'].status.container_statuses[0].container_id.split('://')[1]
    print("Container ID: ", containerid)

    ifname, ifindex = find_veth(containerid)
    if ifname:
        # figure out this container's service name and namespace
        container_name = event['object'].status.container_statuses[0].name
        namespace = event['object'].metadata.namespace
        service_name = container_name_to_service_name(container_name)

        # write the ifname and ifindex into the service status
        patch = {"status":{"proxy-ifname":ifname, "proxy-ifindex":ifindex}}
        api.patch_namespaced_custom_object_status(group=GROUP,version=V1,plural=LB_PLURAL,namespace=namespace,name=service_name,body=patch)


if __name__ == "__main__":
    config.load_kube_config()
    dclient = docker.from_env()

    v1 = client.CoreV1Api()
    w = watch.Watch()
    for event in w.stream(v1.list_pod_for_all_namespaces, label_selector='app=egw,role=proxy'):
        print("Event: %s %s %s" % (event['type'], event['object'].metadata.name, event['object'].metadata.namespace))
        handle_event(event)
